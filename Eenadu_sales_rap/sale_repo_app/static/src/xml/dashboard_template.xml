<?xml version="1.0" encoding="UTF-8"?>
<templates xml:space="preserve">
  <t t-name="sale_repo_app.SalesDashboardDesktopTemplate" owl="1">

    <div class="dashboard-wrapper">
        <button class="floating-button" t-on-click="goToCustomerForm">
            <i class="fa fa-plus-square" style="margin-right:5px; background-color: transparent;"></i>
            Customer Form
        </button>
      <div class="dashboard-main">

        <!-- Header -->
        <div class="dashboard-header">
          <h1>Sales Representative</h1>
          <div class="greeting">Welcome, <span t-esc="state.name"/>!</div>
          <div class="date">Today: <span t-esc="state.date"/></div>
        </div>

        <!-- Agency Selection Card -->
        <div class="dashboard-row">
          <div class="dashboard-card agency-card">

            <!-- Show Change Agency button when select is hidden -->
            <t t-if="!state.showAgencySelect">
              <button class="change-agency-btn" t-on-click="showAgencyDropdown" type="button">
                Change Agency
              </button>

              <!-- Display current agency info -->
              <t t-if="state.selectedAgencyId">
                  <t t-if="state.agencies.length">
                <t t-set="currentAgency" t-value="state.agencies.find(a => a.id == state.selectedAgencyId)" />
                <t t-if="currentAgency">
                  <div class="current-agency-info">
                    <strong>Current Agency:</strong>
                    <span><t t-esc="currentAgency.location_name"/></span>
                    <span>(Code: <t t-esc="currentAgency.code"/>)</span>
                  </div>
                </t>
                </t>
              </t>
            </t>

            <!-- Show agency select when toggled -->
            <t t-if="state.showAgencySelect">
              <label for="agency-select" class="agency-label">Select an agency</label>
              <select id="agency-select"
                      class="form-select"
                      t-model="state.selectedAgencyId"
                      t-on-change="onAgencyChange"
                      t-att-disabled="state.saving">
                <option value="" selected="selected" disabled="disabled">Select agency</option>
                <t t-foreach="state.agencies" t-as="agency" t-key="agency.id">
                  <option t-att-value="agency.id">
                    <t t-esc="agency.location_name"/> (Code: <t t-esc="agency.code"/>)
                  </option>
                </t>
              </select>

              <!-- Saving message -->
              <t t-if="state.saving">
                <div class="info-message">Saving selection…</div>
              </t>

              <!-- Success and error messages -->
              <t t-if="state.saveSuccess">
                <div class="success-message" t-esc="state.saveSuccess"/>
              </t>
              <t t-if="state.saveError">
                <div class="error-message" t-esc="state.saveError"/>
              </t>
            </t>

          </div>
        </div>

        <!-- Dashboard cards -->
        <div class="dashboard-row grid-3">
          <div class="dashboard-card">
            <h3>Houses Visited</h3>
            <div class="dashboard-stats-row">
              <p>Today's Count: <b t-esc="state.target"/></p>
              <p>Total Visited: <b t-esc="state.today_customer_forms_count"/></p>
              <p>Target Left: <b t-esc="state.target_left"/></p>
            </div>
          </div>

          <div class="dashboard-card">
            <h3>Reports</h3>
            <p>Already Subscribed: <b t-esc="state.subscribed_count"/></p>
          </div>

          <div class="dashboard-card">
            <h3>Shift Details</h3>
            <p>Start Time: <b t-esc="state.shift_start_time"/></p>
            <button class="start-work-btn" t-on-click="startWork">Start Work</button>
          </div>
        </div>

        <!-- Loading indicator -->
        <div t-if="state.loading" class="dashboard-loader">Loading…</div>
        <!-- Error message -->
        <div t-if="state.error" class="dashboard-error"><span t-esc="state.error"/></div>
      </div>
    </div>
  </t>
</templates>
